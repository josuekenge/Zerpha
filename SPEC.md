# 1. Product Overview

**Name:** Zerpha
**Type:** AI-powered Vertical SaaS Market Intelligence Dashboard

## Goal
Given a user search like "CRM" or "logistics" or "home healthcare", Zerpha finds up to 5 relevant SaaS companies in that niche. It prefers vertical SaaS companies, but if no clear vertical SaaS exists, general SaaS in that niche is acceptable.

The system scrapes and analyzes their websites, extracts structured insights using Claude, and displays them in a dashboard similar in spirit to Apollo, but simpler. It also lets the user export a slide deck style PDF for a chosen company using Gemini plus Google Slides.

**Target User:** Analyst, tech lead, or M&A oriented engineer who wants a fast, high-level view of SaaS companies in a market.

# 2. Final Tech Stack

## Frontend
*   **React**
*   **TypeScript**
*   **Tailwind CSS**: HTML and basic CSS handled through utility classes.
*   *Note: The frontend talks only to your backend, never directly to AI APIs.*

## Backend
*   **Node.js**
*   **Express.js**
*   **TypeScript**

## Database
*   **Supabase**: Postgres as managed DB, Supabase JS client in backend.

## External APIs
*   **Claude API (Model: Claude 3.5 Sonnet)**
    *   Discover up to 5 SaaS companies for a given niche (preferring vertical SaaS).
    *   Extract structured insights from scraped HTML into JSON.

*   **Supabase API**
    *   Store searches, company data, and report metadata.
*   *ChatGPT API is optional, not required for MVP.*

# 3. Main User Flow

1.  User opens Zerpha and types a query in the search bar (e.g., "CRM" or "logistics software").
2.  Backend sends the query to Claude to find up to 5 relevant SaaS companies. It first tries vertical SaaS; if not possible, general SaaS in that niche is accepted.
3.  For each company, the backend:
    *   Scrapes key pages using fetch.
    *   Sends combined text to Claude for structured extraction.
    *   Saves the extracted JSON in Supabase.
4.  Frontend receives a list of companies and displays them in a dashboard table.
5.  User clicks one company to open the detail panel.


# 4. Functional Requirements

## 4.1 Search and Company Discovery
*   **Search Bar:** Accepts any string input (e.g., "CRM", "fleet management").
*   **Backend Discovery:** Sends a request to Claude with a hidden instruction to return up to 5 relevant SaaS companies, preferring vertical SaaS.
*   **Output:** Claude returns an array of JSON objects (max 5) containing name, website, and reason.

## 4.2 Scraping
For each company website, `scraperService` will use fetch to retrieve HTML for the Homepage, Product/Solutions page, and Pricing/How it works page. It will combine relevant text into a single string or chunked segments.
*   **Depth:** Medium.
*   **Timeouts:** 10 seconds per page request. If a page fails, skip and proceed.

## 4.3 Structured Extraction with Claude
`extractionService` takes the combined scraped text and uses Claude 3.5 Sonnet to output strict JSON.

**JSON Schema per Company:**
*   `name`, `website`, `summary`
*   `product_offering`, `customer_segment`, `tech_stack`
*   `estimated_headcount`, `hq_location`, `pricing_model`
*   `strengths` (list), `risks` (list), `opportunities` (list)
*   `acquisition_fit_score` (0-10), `acquisition_fit_reason`
*   `top_competitors` (list)

Additionally, a separate Claude call generates `global_opportunities` (short text describing top market opportunities in the niche).

**Reliability:**
*   Use try/catch.
*   If JSON is invalid, retry once asking for corrected JSON.
*   If extraction fails, mark company as "failed" and exclude/show error.

## 4.4 Dashboard UI
**Style:** Apollo vibes, but simpler.

**Key Components:**
*   **Top Search Bar:** Text input and search button.
*   **Global Insights Section:** Shows `global_opportunities` generated by Claude.
*   **Companies Table:** Columns for Name, Website, Short Summary, Acquisition Fit Score. Row click selects company.
*   **Detail Panel:** Shows all extracted fields (Summary, Product, Tech Stack, Strengths/Risks/Opportunities, Fit Score, Competitors).
*   *No logos for MVP.*



# 5. Non-Functional Requirements

*   **Response Time:** Total flow per search can take up to 3 minutes (use loading indicators).
*   **Throughput:** Max 5 companies per search.
*   **Parallelism:** Process 1 or 2 companies in parallel for reliability.
*   **Rate Limit:** No strict limit for MVP, but backend handles one search at a time per client.
*   **Error Handling:** If a company fails, skip it; never crash the whole search.

# 6. Data Model and Supabase Plan

Use Supabase as managed Postgres.

**Tables:**
*   `searches`: `id`, `query_text`, `created_at`
*   `companies`: `id`, `search_id` (FK), `name`, `website`, `vertical_query`, `raw_json`, `acquisition_fit_score`, `created_at`
*   `reports`: `id`, `company_id` (FK), `pdf_url` (or storage key), `created_at`

**Usage:** Backend only (Supabase JS client). Creates rows on search, extraction, and export events.

# 7. Backend Architecture

**Routes:**
*   `POST /api/search`: Body `{ query }`. Inserts search, calls Claude discovery, scrapes/extracts for each company, generates global insights, and returns list.
*   `GET /api/search/:searchId`: Returns existing data from DB (no new AI calls).


**Services:**
*   `discoveryService.ts`: Claude discovery.
*   `scraperService.ts`: Fetch HTML.
*   `extractionService.ts`: Claude JSON extraction.

*   `dbService.ts`: Supabase wrapper.

# 8. Frontend Architecture

*   **Stack:** React, TypeScript, Tailwind.
*   **Components:** `SearchPage`, `GlobalInsightsBox`, `CompaniesTable`, `CompanyDetailPanel`.
*   **State:** React Query or hooks for API calls.

# 9. AI Use Summary

*   **Claude 3.5 Sonnet:** Company discovery, structured extraction.

*   **Supabase:** Data persistence.

---

# 10. Implementation Details (Updated 2025-12-03)

## 1. Frontend Implementation
**Tech Stack:** React, Vite, TypeScript, Tailwind CSS, Framer Motion

### 1.1 Landing Page
**Features Implemented:**
*   **Hero Section:** Dynamic typewriter effect, search simulation, emotional gradient background.
*   **About Me Section:** High-level professional profile with experience timeline, education, skills, and social links.
*   **Vision & Capabilities:** "The Zerpha Advantage" highlights and interactive cards.
*   **Pricing:** Tiered pricing display with hover effects.
*   **Navigation:** Sticky navbar with smooth scroll and mobile menu.
*   **Chat Widget:** Integrated support interface.

### 1.2 Authentication (Frontend)
**Features Implemented:**
*   **Auth Context:** `useAuth` hook and protected route wrappers.
*   **UI Integration:** Conditional rendering of login/workspace buttons.

## 2. Backend Implementation
**Tech Stack:** Node.js, Express, TypeScript

### 2.1 Core Services
**Features Implemented:**
*   **Discovery Service:**
    *   AI model interface and discovery algorithms.
    *   **Validation:** Zod schema validation for Claude responses (`discoverySchema`).
    *   **Deduplication:** `diversityService` filters candidates against seen domains (`getSeenDomains`, `selectDiverseCompanies`).
*   **AI Integration:** Claude 4.5 (`@anthropic-ai/sdk`).
*   **Data Processing:** PDF parsing (`pdf-parse`) and Zod validation.
*   **Caching:** In-memory caching (`cacheService.ts`) for company extractions (30 min TTL) to avoid redundant AI calls.
*   **Global Opportunities:** Generated via `insightsService` and stored in `searches.global_opportunities`.

### 2.2 API & Security
**Features Implemented:**
*   **API Structure:** RESTful endpoints and structured logging (`pino`).
*   **Security:** `helmet` headers and `cors` configuration.
*   **Missing:** Rate limiting (Needs implementation).

### 2.3 Authentication (Backend)
**Features Implemented:**
*   **Middleware:** Supabase JWT verification and RBAC foundations.

### 2.4 Scraping Rules (Verified)
*   **Timeout:** 8 seconds per page request (`scraperService.ts`).
*   **Content Limit:** Combined text truncated to 15,000 characters before extraction.
*   **Stripping:** HTML tags (`script`, `style`) removed; whitespace normalized.

## 3. Storage & Infrastructure
**Provider:** Supabase

### 3.1 Data Persistence
**Features Implemented:**
*   **Database:** Managed PostgreSQL with tables for `searches`, `companies`, `reports`.
*   **Storage:** File asset storage configured.

### 3.2 Authentication & User Management
**Features Implemented:**
*   **Supabase Auth:** Client/Server auth flow and session persistence.

### 3.3 Deployment
**Features Implemented:**
*   **Environment:** `dotenv` management and TypeScript build system.

---

# 11. Railway Deployment Guide

## 1. Backend Deployment (Railway)

### 1.1 Project Structure
The backend must be deployed from the `backend/` directory. Railway needs to know where to find the Dockerfile or build commands.

### 1.2 Required Environment Variables (Railway Dashboard)
**CRITICAL:** Railway does NOT read your local `.env` file. You MUST manually add these variables in the Railway Dashboard â†’ Your Service â†’ Variables:

| Variable | Description | Example |
|----------|-------------|---------|
| `PORT` | Railway sets this automatically | `3001` (or Railway's assigned port) |
| `SUPABASE_URL` | Your Supabase project URL | `https://xxxxx.supabase.co` |
| `SUPABASE_ANON_KEY` | Your Supabase anon/public key | `eyJhbGciOiJIUzI1NiIs...` |
| `ANTHROPIC_API_KEY` | Claude API key for AI features | `sk-ant-api03-...` |
| `NODE_ENV` | Environment mode | `production` |

### 1.3 Railway Configuration (railway.json or Dashboard)
```json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "npm start",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 30
  }
}
```

### 1.4 Backend package.json Scripts
Ensure these scripts exist in `backend/package.json`:
```json
{
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "tsx watch src/index.ts"
  }
}
```

### 1.5 Health Check Endpoint
The `/health` endpoint MUST be database-independent to pass Railway's health checks:
```typescript
app.get('/health', (_req, res) => {
  res.status(200).json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    port: process.env.PORT || 3001,
  });
});
```

### 1.6 CORS Configuration
Backend must allow the frontend origins:
```typescript
const allowedOrigins = [
  'https://www.zerpha.ca',
  'https://zerpha.ca',
  'https://zerpha.netlify.app',
  'http://localhost:5173',  // Local development
  'http://localhost:3000',
];
```

## 2. Frontend Deployment (Netlify)

### 2.1 Required Environment Variables (Netlify Dashboard)
| Variable | Description | Example |
|----------|-------------|---------|
| `VITE_API_BASE_URL` | Backend API URL | `https://zerpha-production.up.railway.app` |
| `VITE_SUPABASE_URL` | Supabase project URL | `https://xxxxx.supabase.co` |
| `VITE_SUPABASE_ANON_KEY` | Supabase anon key | `eyJhbGciOiJIUzI1NiIs...` |

### 2.2 Local Development Override
Create `frontend/.env.local` to override production URLs locally:
```
VITE_API_BASE_URL=http://localhost:3001
```
This file is gitignored and takes precedence over `.env` for local development.

### 2.3 API Client Configuration
The frontend API client (`frontend/src/api/config.ts`) should:
1. Use `VITE_API_BASE_URL` environment variable
2. Fallback to `http://localhost:3001` for local development
3. Log the connection URL for debugging

## 3. Troubleshooting

### 3.1 "CORS Error" but Backend is Down
**Symptom:** Browser shows CORS errors, but the real issue is a 502 Bad Gateway.
**Cause:** When the backend crashes, Railway returns an HTML error page without CORS headers.
**Solution:** Check Railway logs for the actual error (usually missing environment variables).

### 3.2 Railway 502 Bad Gateway
**Common Causes:**
1. Missing `SUPABASE_URL` or `SUPABASE_ANON_KEY` in Railway Variables
2. Health check failing (ensure `/health` doesn't depend on database)
3. Build failed (check Railway build logs)
4. Wrong start command (should be `npm start`, not `npm run dev`)

### 3.3 Frontend Hitting Wrong Backend URL
**Symptom:** Local frontend calls production Railway URL instead of localhost.
**Solution:**
1. Create `frontend/.env.local` with `VITE_API_BASE_URL=http://localhost:3001`
2. Restart Vite dev server (it only reads env files at startup)
3. Clear Vite cache: `rm -rf node_modules/.vite`

### 3.4 Verifying Local Setup
Run these checks:
1. Backend health: `curl http://localhost:3001/health`
2. Frontend console should show: `ðŸ”Œ API Client connecting to: http://localhost:3001`
3. Network tab should show requests to `localhost:3001`, not `railway.app`

## 4. Deployment Checklist

### Before Deploying Backend to Railway:
- [ ] Add `SUPABASE_URL` to Railway Variables
- [ ] Add `SUPABASE_ANON_KEY` to Railway Variables
- [ ] Add `ANTHROPIC_API_KEY` to Railway Variables
- [ ] Verify `/health` endpoint works without database
- [ ] Verify CORS includes production frontend URLs

### Before Deploying Frontend to Netlify:
- [ ] Set `VITE_API_BASE_URL` to Railway backend URL
- [ ] Set `VITE_SUPABASE_URL` in Netlify
- [ ] Set `VITE_SUPABASE_ANON_KEY` in Netlify
- [ ] Verify build command: `npm run build`
- [ ] Verify publish directory: `dist`

---

# 12. Feature Implementations (Updated 2025-12-07)

## 12.1 Pipeline Management System

### Overview
Full-featured deal pipeline with Kanban board, backlog view, and summary dashboard for tracking acquisition targets through stages.

### Pipeline Stages
- **NEW** â†’ **RESEARCHING** â†’ **CONTACTED** â†’ **IN DILIGENCE** â†’ **CLOSED**

### Components
| Component | File | Description |
|-----------|------|-------------|
| PipelinePage | `frontend/src/components/PipelinePage.tsx` | Main pipeline view with Board/Summary/Backlog tabs, drag-and-drop Kanban |
| PipelineBacklog | `frontend/src/components/PipelineBacklog.tsx` | Linear list view of all pipeline companies with stage badges |
| PipelineSummary | `frontend/src/components/PipelineSummary.tsx` | Pipeline analytics and closed deals display |
| PipelineDetailPanel | `frontend/src/components/PipelineDetailPanel.tsx` | Jira-style side panel for backlog with inline editing |
| PipelineDetailModal | `frontend/src/components/PipelineDetailModal.tsx` | Full detail modal for board/summary views |

### Features Implemented
- **Drag-and-Drop:** DND-Kit integration for moving companies between stages
- **Notes System:** Per-company notes with title, body, and timestamp (`notes`, `notes_title`, `notes_updated_at`)
- **Stage Dropdown:** Quick stage changes from detail panels
- **Delete Functionality:** Remove companies from pipeline with confirmation
- **Key Contacts:** Displays people associated with each pipeline company

### Database Migrations Required
```sql
-- supabase/migrations/0009_add_pipeline_stage.sql
ALTER TABLE companies ADD COLUMN IF NOT EXISTS pipeline_stage text;

-- supabase/migrations/0010_add_pipeline_notes.sql  
ALTER TABLE companies ADD COLUMN IF NOT EXISTS notes text;
ALTER TABLE companies ADD COLUMN IF NOT EXISTS notes_title text;
ALTER TABLE companies ADD COLUMN IF NOT EXISTS notes_updated_at timestamptz;
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/pipeline` | Fetch all pipeline companies grouped by stage |
| GET | `/api/pipeline/:companyId` | Fetch single pipeline company detail |
| PATCH | `/api/pipeline/:companyId` | Update stage, notes, or remove from pipeline |

---

## 12.2 People/Contacts Management

### Overview
Contact database scraped from Apify with email discovery, role detection, and company association.

### PeoplePage Component (`frontend/src/components/PeoplePage.tsx`)
Enhanced contacts table with:

**Columns Displayed:**
- NAME (full_name) - with CEO/Founder/Executive badges
- ROLE - job title
- SENIORITY - C-Level, VP, Director, Manager, Other
- DEPARTMENT - Engineering, Sales, Marketing, Finance, HR, Operations
- EMAIL - clickable mailto links
- LINKEDIN - clickable icon linking to profile
- CONFIDENCE SCORE - percentage badge (green/yellow/red)
- SOURCE - data origin (apify, manual, etc.)

**Filtering:**
- Seniority filter (C-Level, VP, Director, Manager)
- Department filter (Engineering, Sales, Marketing, Finance, HR, Operations)
- Full-text search (name, email, role, company)

**Special Features:**
- Unverified Contacts section at bottom (null `full_name`)
- Default sorting by confidence_score DESC
- Delete functionality per contact

### People Database Schema
```typescript
interface Person {
  id: string;
  email: string | null;
  full_name: string | null;
  first_name: string | null;
  last_name: string | null;
  role: string | null;
  seniority: 'C-Level' | 'VP' | 'Director' | 'Manager' | 'Other' | null;
  department: string | null;
  phone: string | null;
  linkedin_url: string | null;
  company_name: string | null;
  company_website: string | null;
  company_id: string | null;
  source: string;
  confidence_score: number | null;
  is_ceo: boolean;
  is_founder: boolean;
  is_executive: boolean;
  location_city: string | null;
  location_country: string | null;
  created_at: string;
}
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/people` | Fetch all people with optional filters |
| GET | `/api/people/:id` | Fetch single person detail |
| GET | `/api/people/company/:companyId` | Fetch people by company |
| DELETE | `/api/people/:id` | Delete a person |

---

## 12.3 Company Avatar & Favicon System

### CompanyAvatar Component (`frontend/src/components/CompanyAvatar.tsx`)
Reusable component for displaying company logos/favicons across the application.

**Favicon Resolution Order:**
1. Use provided `faviconUrl` if available (from backend/database)
2. Generate from website domain using Google's favicon service: `https://www.google.com/s2/favicons?sz=64&domain_url={hostname}`
3. Fall back to letter avatar (first letter of company name)

**Props:**
```typescript
interface CompanyAvatarProps {
  name: string;                    // Company name (used for fallback)
  faviconUrl?: string | null;      // Direct favicon URL
  website?: string | null;         // Domain used to generate favicon
  size?: number;                   // Pixel size (default: 24)
  className?: string;              // Additional CSS classes
}
```

**Components Using CompanyAvatar:**
- PipelinePage (board cards)
- PipelineBacklog (list rows)
- PipelineSummary (closed deals)
- PipelineDetailPanel (header)
- PipelineDetailModal (header)
- CompanyListItem (workspace list)
- CompanyDetailPanel (detail view)
- PeoplePage (company column)

---

## 12.4 Insights Page

### InsightsPage Component (`frontend/src/components/InsightsPage.tsx`)
AI-powered market intelligence dashboard showing:
- Global market opportunities
- Industry trends
- Portfolio health metrics
- Recommended actions

---

## 12.5 Chat Widget

### ChatWidget Component (`frontend/src/components/ChatWidget.tsx`)
Floating AI assistant with two modes:
- **Floating Mode:** Collapsible chat bubble in corner
- **Embedded Mode:** Inline chat panel in detail views

**Features:**
- Context-aware responses (knows current company/person being viewed)
- Markdown rendering for responses
- Zerpha branding with logo

---

## 12.6 UI/UX Enhancements

### Fit Score Pills
Premium gradient pill badges for acquisition fit scores:
- **High (7.5-10):** Teal gradient (`#2DD4BF` â†’ `#0F766E`)
- **Medium (5-7.4):** Amber gradient (`#FCD34D` â†’ `#B45309`)
- **Low (0-4.9):** Red gradient (`#FCA5A5` â†’ `#B91C1C`)

### View Modes
- **Table View:** Traditional list with sortable columns
- **Cards View:** Grid layout with company cards

### Responsive Design
- Mobile hamburger menu
- Collapsible sidebar navigation
- Responsive table columns (hidden on smaller screens)

---

## 12.7 Search Enhancements

### Discovery Service Updates
- Returns up to 10 companies per search (increased from 5)
- Deduplication: Avoids returning companies user has already saved
- Result variety: Small randomness for repeated searches
- Enhanced fields: `description`, `industry`, `country`

---

## 12.8 Legal Pages

### Privacy Policy & Terms of Service
- `/privacy-policy` â†’ `PrivacyPolicy.tsx`
- `/terms-of-service` â†’ `TermsOfService.tsx`
- Footer links on landing page
- Scroll-to-top on logo click

---

# 13. Recent Updates (Updated 2025-12-12)

## 13.1 Dark Mode Implementation
Comprehensive dark mode support added across the entire application.
- **Theme Toggle:** Located in the top-right header (Sun/Moon icon).
- **Persistence:** Theme preference saved in local storage via `useTheme` hook.
- **Components Styled:**
  - Sidebar & Navigation
  - Search History & Results
  - Companies Table & Cards
  - People Directory & Detail Panels
  - Pipeline Board, Summary, and Backlog
  - Modals & Slide-overs
  - Scrollbars (custom styled for dark mode)

## 13.2 Pipeline UI Redesign
Complete visual overhaul of the Pipeline section to match premium dashboard aesthetics.
- **Summary Dashboard:**
  - 4-card key metrics row (Total Companies, Active Deals, Closed Deals, Conversion Rate) with color-coded icons.
  - Horizontal bar chart for "Pipeline by Stage".
  - Donut chart for "Stage Overview".
  - "Recently Closed" list with fit score badges.
- **Kanban Board:**
  - Refined card design with cleaner typography and hover effects.
  - Improved drag-and-drop visual feedback.
- **Toolbar:**
  - Segmented control style toggle for Board/Summary/Backlog views.
  - Positioned in the top-right for better accessibility.

## 13.3 UI Refinements
- **Create Workspace Modal:** Reduced size of input fields and buttons for a more compact, professional look.
- **Filters:** Relocated filters to the sidebar for better usability in the Companies view.
- **Scrollbars:** Custom CSS scrollbars that adapt to light/dark mode (Slate-300 in light, Slate-700 in dark).

## 13.4 Data Richness Restoration
Restored full data extraction capabilities in the backend `discoveryService`.
- **Fields Restored:** Executive summary, acquisition fit analysis, product details, operations data, and key people.
- **Optimization:** Balanced richness with performance to prevent timeouts while ensuring high-quality data.

